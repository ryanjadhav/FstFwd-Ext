<!DOCTYPE html>
<html>
  	<head>
    	<title>FstFwd</title>
		<link href="popup.css" rel="stylesheet" type="text/css">
  	</head>
	<body>
		<h2>FstFwd</h2>
	
		<div class="track_input">
			<div class="artist_container">
				<label id="artist_label" for="artist_input"> Artist: </label>
				<input id="artist_input" type="text" />
			</div>
			
			<div class="song_container">
				<label id="artist_label" for="song_input"> Song: </label>
				<input id="song_input" type="text"  />
			</div>
			
			<input id="submit" type="submit" value="Submit" />
		</div>
		
		<div class="track_link" style="display:none;">
			<span class="grooveshark_url"></span>
			<span class="spotify_url"></span>
		</div>
		
		<script type="text/javascript" src="jquery-1.6.2.min.js"></script>
		<script type="text/javascript">
		
		var submitHandler = function(){
			var artist = $('#artist_input').val();
			var song = $('#song_input').val();
			
			var query = createQuery(artist, song);
			
			console.log("query: " + query);
			
			groovesharkFetch(query);
			spotifyFetch(query);
			
			$('.track_link').show();
		};
		
		var createQuery = function(artist, song){
			artist = artist.replace(' ', '+');
			song = song.replace(' ', '+');
			
			var middle = '+';
			
			if(song == ''){
				middle = '';
			}
			
			var query = artist + middle + song;
			
			return query;
		};
		
		var spotifyFetch = function(query){
			$.ajax({
				url: 'http://ws.spotify.com/search/1/track.json?q=' + query,
				success: function(data){
					console.log("Spotify: ");
					console.log(data);
					if(!data || data.tracks.length == 0){
						$('.spotify_url').html("No Spotify Results found.");
					} else {					
						var trackCode = data.tracks[0].href.split(':');
						var spotify_url = 'http://open.spotify.com/track/' + trackCode[2];
					
						$('.spotify_url').html("<a href='javascript:chrome.tabs.create({\"url\":\"" + spotify_url +"\", \"selected\":true});window.close();'>Spotify</a>");
						
					}
				},
				error: function(){
					console.log("there was an error with spotify.");
				}
			});
		};
		
		//This api needs to call the real grooveshark api.
		var groovesharkFetch = function(query){
			$.ajax({
				url: 'http://tinysong.com/a/'+ query
				+'?format=json&key=b4385955bd9dd410287d0b3c7ffee5c8',
				success: function(data){
					console.log("Grooveshark: ");
					console.log(data);
					if(data.length === 2){
						$('.grooveshark_url').html('No Grooveshark results found.');
					} else {
						data = data.replace(/"/g, '');
						data = data.replace(/\\/g, '');
						var grooveshark_url = unescape(data);
					
 						$('.grooveshark_url').html("<a href='javascript:chrome.tabs.create({\"url\":\"" + grooveshark_url +"\", \"selected\":true});window.close();'>Grooveshark</a>");
					}
				},
				error: function(){
					console.log("there was an error with grooveshark.");
				}
			});
		};
		
		$(document).ready(function(){
			$('#submit').click(submitHandler);
		});	
		</script>
	</body>
</html>